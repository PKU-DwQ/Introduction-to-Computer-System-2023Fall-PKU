#4556277 2022-12-28 17:19 关注数：56 回复数：67

#proxylab

求问 https 连接的具体过程是什么样的，感觉 writeup 上写的不是很清楚，dz 自己上网查也没太弄明白

#20572802 2022-12-28 17:20

[Alice] 我也

#20572859 2022-12-28 17:22

[Bob] 其实也不用明白 https 具体是怎么握手的，只要让 proxy 接到 connect 指令后无脑转发就好....

#20572932 2022-12-28 17:26

[洞主] Re Bob: dz 尝试了无脑转发，然后失败了 😂 应该是转发的内容有问题

#20576420 2022-12-28 19:58

[Carol] 我试了无脑转发结果失败了…反正就两分不要也罢

#20576560 2022-12-28 20:03

[Bob] Re 洞主: 收到啥就转发啥就行，不用进行任何处理..

#20576662 2022-12-28 20:06

[Dave] Re Bob: 测试 https 的是 real-2048 吗？

#20576683 2022-12-28 20:06

[Bob] Re Dave: 应该是的

#20579925 2022-12-28 22:00

[Eve] 你要做的事情是这样的

#20579958 2022-12-28 22:01

[Eve] 首先，读入客户端的 connect 请求报头，与服务器建立连接，给客户端发回

#20579966 2022-12-28 22:01

[Eve] HTTP/1.1 200 Connection Established\r\nConnection: close\r\n\r\n

#20580030 2022-12-28 22:03

[Eve] 然后，用两个线程(其中一个可以是主线程)分别进行服务器 → 客户端和客户端 → 服务器的转发，注意要使用 Unix read 函数而不是 rio 的包装函数

#20580084 2022-12-28 22:05

[Eve] 这部分是今年贵校新加的……writeup 确实写的很烂，和 CMU 写的 writeup 形成了鲜明对比

#20580450 2022-12-28 22:17

[Dave] Re Eve: ！那想请问一下 E 大佬，proxy 给服务器发请求的时候 request line 是“GET / HTTP/1.0”还是什么呢？我这边一直提示说“400 The plain HTTP request was sent to HTTPS port”

#20581608 2022-12-28 23:00

[Dave] Re Eve: ！！！！！！感谢 Eve 大善人 😭 不需要 request line/request header，，过了！！！！！祝 Eve 绩点高高平安喜乐 😭😭

#20584489 2022-12-29 00:28

[Eve] Re Dave: 哈哈没事没事

#20589753 2022-12-29 10:08

[洞主] 谢谢 eve 和各位积极讨论的洞友，dz 也做出来啦

#20598644 2022-12-29 17:17

[Francis] Re Eve: 感谢 Eve,以及能不能问一问为什么用 Rio 包装函数就会 timeout,但是用 read 就不会呢? 我这几天一直卡在这个地方, 看了树洞才发现

#20604052 2022-12-29 21:07

[Grace] Re Eve: Eve 大佬能说一下 CONNECT 报头后面还有啥要加的嘛，我看 writeup 后面还有一行 HOST，然后下面又是省略号，不知道报头是不是要像 HTTP 一样全部写上

#20607743 2022-12-29 23:14

[Eve] Re Francis: 如果你看了书上代码就会发现，为了所谓的鲁棒性，rio 的函数在遇到不足值时会反复调用 read。例如你以 MAXLINE 为参数调用 rio 的函数，而客户端只输入了不到 MAXLINE 个字节，这时就会无限阻塞在 rio 函数调用的 read 里

#20607777 2022-12-29 23:15

[Eve] Re Francis: 注意这时客户端还在等待服务器的回复，没有断开连接，所以 read 也不会检测到 EOF

#20607958 2022-12-29 23:20

[Eve] Re Grace: 把 CONNECT 报头全部读入(结束标志是一个空行)，然后扔掉就可以了，不用转发给任何人

#20615028 2022-12-30 11:01

[Grace] Re Eve: 哦哦哦好的，谢谢 E 君，我这就去试试

#20647179 2022-12-31 20:37

[Grace] Re Eve: 我也做出来啦，谢谢 E 君~祝 E 君和洞里其他朋友新年快乐~

#20647192 2022-12-31 20:38

[Grace] 顺便我调这个第四部分调了好几天，也可以回答一下后来看到这里的朋友的问题了 23333

#20655394 2023-01-01 11:42

[Alice] Re Grace: 谢谢 Grace。请问 real page 这一部分总是那两个 cache 的测试过不了，就是 cahce-lru/concurrent，可能是什么原因呢？

#20656689 2023-01-01 13:31

[Grace] Re Alice: 我感觉可能是互斥锁的问题？我之前 CACHE 出问题的时候是因为有一个地方的 IF 语句里面我 RETURN 了但是忘记把锁释放了，A 君可以检查一下有没有一些地方加锁/释放锁漏写了或者写错了

#20657761 2023-01-01 14:42

[Alice] Re Grace: 满分了，谢谢 G。是因为服务器响应可能是二进制文件，所以一些 IO 函数要改，我忘了。

#20658567 2023-01-01 15:30

[Grace] Re Alice: 嗷那就是 MEMCPY 的问题哈哈哈

#20663465 2023-01-01 18:43

[Hans] 请问怎么实现在 TCP 一端关闭的时候另一个线程也退出呀

#20665180 2023-01-01 20:01

[Grace] Re Hans: 不需要吧，客户端和服务器的线程是分离的，两边不一定要同步退出吧

#20674272 2023-01-02 08:30

[Isabella] Re Eve: 我也过了，谢谢 E 君！

#20675890 2023-01-02 11:15

[Hans] Re Grace: 谢谢 还想问下 proxy 用 rio 给客户端发回 200 之后就可以直接开始 read 了吗，中间还有什么操作呢，我 read 一直没有反应

#20676132 2023-01-02 11:28

[Grace] Re Hans: 对，发回 Established 信号之后就可以创建线程了，主线程+对等线程分别完成服务器到客户端/客户端到服务器的信息传输

#20680093 2023-01-02 15:16

[Jason] Re Grace: 请问这两步信息传输需要打开新的套接字描述符吗，还是用原来的两个就行？

#20680904 2023-01-02 16:12

[Grace] Re Jason: 不需要的，就用原来的就行

#20682542 2023-01-02 17:41

[Jason] Re Grace: 好的，谢谢 G 君

#20688176 2023-01-02 22:06

[Kate] 请问为什么要开两个线程，不能一个线程把两件事都干了吗

#20688189 2023-01-02 22:06

[Kate] 以及，怎么判断对面的 socket 关掉了啊，，，好像线程也不能一直挂着吧（不太会）

#20688581 2023-01-02 22:19

[Grace] Re Kate: 我理解的是 real-2048 是实时交互的，你一个线程内只能是线性的要么先等服务器弄完要么先等客户端弄完，这个显然没法玩 2048.然后线程你 detach 分离出来就行了反正自动回收，不用管对面关没关

#20694338 2023-01-03 02:06

[Louis] 请问最后 realpage 里 cache-concurrency/lru 两个点怎么过呀？听说要把数据缓存的 strcpy 改成 memcpy，还有读数据的那个地方用 readnb，dz 改了之后还是过不去 qaq，是除了这两个地方还有要改的吗？rio 包的读写对于二进制文件还可以用嘛？

#20696337 2023-01-03 09:39

[Grace] Re Louis: 这个我感觉是 CACHE 写的有问题？也有可能是互斥锁有地方漏了。rio 对二进制文件可以用的，反正我除了 HTTPS 用了 READ 其他地方都是 RIO，也没用 READNB

#20697118 2023-01-03 10:33

[Margaret] Re Grace: 想问问 G 君是不是不处理 CONNECT 报头那 realpage 就必然都会爆 0 呢？

#20697210 2023-01-03 10:38

[Hans] Re Grace: 我又回来了 555 可以麻烦说一下 2048 那一组有几个 connect，以及 client 和 server 传了大概多少 byte 数据吗，我这里 read 的话第一次 client 返回-1 挂了，第二次 server 返回-1 挂了，然后就报 timeout

#20697364 2023-01-03 10:47

[Grace] Re Margaret: 不会呀，CONNECT 就一个点，其他像 TINY 一样先判断下是不是 GET 就行

#20697404 2023-01-03 10:49

[Grace] Re Hans: 嘶，好像和数据大小关系不大诶，我调试的时候都没关心过大小，不过 READ 我就是一个字符一个字符读的，读完就完了（（

#20697475 2023-01-03 10:52

[Hans] Re Grace: 那 read 读完是-1 退出还是 0 退出呢（

#20697779 2023-01-03 11:12

[Grace] Re Hans: 0 吧，遇到-1 的话肯定是读中途出问题了

#20698401 2023-01-03 11:45

[Margaret] Re Grace: qwq 想问一下 G 君我第一个 sancheck 就过不了是为什么啊（它说我 useragent hdr 错了（（但是明明我是复制黏贴...而且如果真的 useragent 都错了的话之前的样例是怎么过的嘛（）

#20698883 2023-01-03 12:14

[Jason] 我在 2048 里面用 read 的时候总会报错 read：bad file descriptor，不知道为什么 😭

#20699757 2023-01-03 13:08

[Grace] Re Margaret: 嘶，这个问题我还真没遇到...好奇怪

#20699775 2023-01-03 13:10

[Grace] Re Jason: 我查了一下貌似是有的地方没 CLOSE？然后到达上限之后就打不开新的了

#20699792 2023-01-03 13:11

[Margaret] Re Grace: 嘶...我甚至怀疑是没有给浏览器 setting 里面代理设置好（（但是显然不应该是这样啊

#20700009 2023-01-03 13:22

[Grace] Re Margaret: 浏览器那个只影响自己调试嘛，肯定不影响跑分的

#20700240 2023-01-03 13:35

[Margaret] Re Grace: qaq 请问一下 Grace 除了 cache 还有哪里需要加锁吗...因为我好像 realpage 调试的时候 www 只有一开始的一些 proxy 处理了报头到了后面就不处理了（似乎

#20700574 2023-01-03 13:52

[Jason] Re Grace: 谢谢，确实是这样的。那么 G 君是在哪里 close 的呢？我总觉得两个线程传数据，如果一个传完了 close 掉，另一个线程还没传完，那不就出问题了吗？

#20701267 2023-01-03 14:30

[Grace] Re Margaret: 其他地方应该是没有锁的，就 CACHE 需要，不过很容易漏写

#20701300 2023-01-03 14:32

[Grace] Re Jason: 我都是传完了在 return 的时候 CLOSE 的，但线程 DETACH 之后是自动回收的吧感觉好像没啥问题

#20701411 2023-01-03 14:41

[Margaret] Re Grace: doge !是因为在 realpage 里面用了 cache 然后溢出了 ww

#20701898 2023-01-03 15:16

[Grace] Re Margaret: 啊这哈哈哈哈哈

#20720309 2023-01-04 10:03

[Nathan] 请问一下，real-page 2048 为什么我的代理能从客户端读内容，但在 server 段读会卡住呢（用的是 read）

#20721640 2023-01-04 11:08

[Grace] Re Nathan: 是分了线程的读入的吗？如果同一个线程处理双方通信肯定会卡住的

#20722514 2023-01-04 11:44

[Nathan] Re Grace: 是的

#20726387 2023-01-04 14:40

[Grace] Re Nathan: 嘶，那我也不太清楚，也许 CONNECT 报头之类的少了\r\n?

#20749834 2023-01-05 13:59

[Kate] 淦，终于跑通了

#20749848 2023-01-05 14:00

[Kate] 查了 https 的机制才知道，request header 是给 proxy 看的，不需要发给服务器

#20749861 2023-01-05 14:01

[Kate] proxy 只需要把 header 读完丢掉，发个 success 回去，然后闭着眼睛转发就行了

#20784017 2023-01-06 21:25

[Grace] 马上要截至了，完结撒花！（大逃
